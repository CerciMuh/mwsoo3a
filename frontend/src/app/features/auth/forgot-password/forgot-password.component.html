<section class="card shadow-sm">
  <div class="card-body p-4 p-md-5">
    <h1 class="h4 mb-2 text-center">Forgot your password?</h1>
    <p class="text-muted text-center mb-4">
      We’ll email you a verification code so you can set a new password.
    </p>

    <div *ngIf="message()" class="alert alert-info mb-4">
      {{ message() }}
    </div>
    <div *ngIf="error()" class="alert alert-danger mb-4">
      {{ error() }}
    </div>

    <form
      *ngIf="!isResetStep(); else resetTemplate"
      [formGroup]="requestForm"
      (ngSubmit)="submitRequest()"
      class="vstack gap-3"
    >
      <div>
        <label class="form-label" for="email">Email</label>
        <input
          id="email"
          type="email"
          class="form-control"
          formControlName="email"
          autocomplete="email"
          [class.is-invalid]="requestForm.controls.email.invalid && requestForm.controls.email.touched"
        />
        <div class="invalid-feedback" *ngIf="requestForm.controls.email.invalid && requestForm.controls.email.touched">
          Please enter the email associated with your account.
        </div>
      </div>

      <button type="submit" class="btn btn-primary w-100" [disabled]="requestForm.invalid || loading()">
        <span *ngIf="loading(); else requestLabel" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        <ng-template #requestLabel>Send verification code</ng-template>
      </button>

      <div class="text-center small">
        <a routerLink="/auth/login">Back to sign in</a>
      </div>
    </form>

    <ng-template #resetTemplate>
      <form [formGroup]="resetForm" (ngSubmit)="submitReset()" class="vstack gap-3">
        <div>
          <label class="form-label" for="code">Verification code</label>
          <input
            id="code"
            type="text"
            class="form-control"
            formControlName="code"
            autocomplete="one-time-code"
            [class.is-invalid]="resetForm.controls.code.invalid && resetForm.controls.code.touched"
          />
          <div class="invalid-feedback" *ngIf="resetForm.controls.code.invalid && resetForm.controls.code.touched">
            Enter the code from the email we sent.
          </div>
        </div>

        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label" for="password">New password</label>
            <input
              id="password"
              type="password"
              class="form-control"
              formControlName="password"
              autocomplete="new-password"
              [class.is-invalid]="resetForm.controls.password.invalid && resetForm.controls.password.touched"
            />
            <div class="invalid-feedback" *ngIf="resetForm.controls.password.invalid && resetForm.controls.password.touched">
              Password must contain at least 8 characters.
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="confirmPassword">Confirm new password</label>
            <input
              id="confirmPassword"
              type="password"
              class="form-control"
              formControlName="confirmPassword"
              autocomplete="new-password"
              [class.is-invalid]="(resetForm.controls.confirmPassword.invalid && resetForm.controls.confirmPassword.touched) || resetForm.hasError('passwordMismatch')"
            />
            <div class="invalid-feedback" *ngIf="resetForm.hasError('passwordMismatch')">
              Passwords do not match.
            </div>
          </div>
        </div>

        <button type="submit" class="btn btn-primary w-100" [disabled]="resetForm.invalid || loading()">
          <span *ngIf="loading(); else resetLabel" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          <ng-template #resetLabel>Update password</ng-template>
        </button>

        <button type="button" class="btn btn-link d-block w-100" (click)="backToRequest()">Start over</button>
      </form>
    </ng-template>
  </div>
</section>
